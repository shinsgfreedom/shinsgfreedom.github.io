<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ì¹´ì¹´ì˜¤ ì§€ë„ CSV í•€ ì°ê¸°</title>
    <style>
        body { margin:0; padding:0; display:flex; height:100vh; }
        #left { width:300px; padding:12px; box-sizing:border-box; border-right:1px solid #ddd; }
        #map { flex:1; height:100%; }
        button { padding:8px 12px; margin-bottom:10px; width:100%; }
        .mapInfo {padding:5px; width:200px; overflow: scroll}
    </style>
</head>
<body>

<div id="left">
    <select id="area" style="width:100%; height:30px; margin-bottom:10px;">
        <option value="">ì§€ì—­ ì„ íƒ</option>
        <option value="songpa" selected>ê°•ë‚¨/ê´‘ì§„/ì†¡íŒŒ</option>
    </select>
    <button id="loadBtn">CSV ë¶ˆëŸ¬ì™€ì„œ í•€ ì°ê¸°</button>
    <div id="status">ìƒíƒœ: ëŒ€ê¸°</div>
    <ul id="result"></ul>
</div>

<div id="map"></div>

<!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK (í•„ìˆ˜: services ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e460c26a9dfe2fa0b1835052c2116608&libraries=services"></script>
<!--<script src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=c9684df8cab7a761f65cd6492b2a3363&libraries=services"></script>-->

<script>
    let map;
    let markers = [];
    let bounds = new kakao.maps.LatLngBounds();
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");

    window.onload = function () {
        map = new kakao.maps.Map(document.getElementById("map"), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7
        });
    };

    function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
        bounds = new kakao.maps.LatLngBounds();
        resultEl.innerHTML = "";
    }

    async function loadCSV() {

        const file = document.getElementById("area").value;

        if (file === '') {
            alert('ì§€ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”')
            document.getElementById("area").focus()
            return
        }

        statusEl.textContent = "ìƒíƒœ: CSV ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";


        let text;
        try {
            // ğŸ“Œ ì„œë²„ CSV ë¶ˆëŸ¬ì˜¤ê¸°
            const res = await fetch(`http://localhost/data/${file}.csv`);
            text = await res.text();
        } catch (err) {
            statusEl.textContent = "ìƒíƒœ: CSV ë¡œë“œ ì‹¤íŒ¨";
            return;
        }

        // ğŸ“Œ CSV ì¤„ ë‚˜ëˆ„ê¸°
        const lines = text
            .split(/\r?\n/)
            .map(v => v.trim())
            .filter(v => v.length > 0);

        const list = [];

        // ğŸ“Œ ê° ì¤„ì„ label, address ë¡œ ìë™ ë§¤í•‘
        lines.forEach(line => {
            const cols = line.replace(/"/g, "").split(",");
            if (cols.length >= 2) {
                list.push({
                    label: cols[0].trim(),
                    address: cols[1].trim(),
                    lng: cols[2].trim(),
                    lat: cols[3].trim(),
                    full: cols[4].trim(),
                });
            }
        });

        statusEl.textContent = `ìƒíƒœ: ${list.length}ê°œ ì£¼ì†Œ ë³€í™˜ì¤‘â€¦`;

        await plotAddresses(list);

        statusEl.textContent = "ìƒíƒœ: ì™„ë£Œ";
    }

    async function plotAddresses(list) {
        console.log(list);
        clearMarkers();

        for (const item of list) {
            try {
                const pos = new kakao.maps.LatLng(item.lat, item.lng);
                bounds.extend(pos);

                const marker = new kakao.maps.Marker({ position: pos });
                marker.setMap(map);
                markers.push(marker);

                // new kakao.maps.InfoWindow({
                //     content: `<div style="padding:6px;">${item.address}</div>`
                // }).open(map, marker);

                // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                let infowindow = new kakao.maps.InfoWindow({
                    content : `<div class="mapInfo">${item.full}</div>`,
                    removable : true
                });

                // ë§ˆì»¤ì— í´ë¦­ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                kakao.maps.event.addListener(marker, 'click', function() {
                    // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
                    infowindow.open(map, marker);
                });

                // // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                // kakao.maps.event.addListener(marker, 'mouseover', function() {
                //     // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ë§ˆì»¤ìœ„ì— í‘œì‹œí•©ë‹ˆë‹¤
                //     infowindow.open(map, marker);
                // });

                // // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                // kakao.maps.event.addListener(marker, 'mouseout', function() {
                //     // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤
                //     infowindow.close();
                // });

                resultEl.innerHTML += `<li><strong>${item.label}</strong> <br> ${item.address}</li>`;
            } catch (e) {
                resultEl.innerHTML += `<li>${item.label} â†’ ë³€í™˜ ì‹¤íŒ¨</li>`;
            }
        }

        if (markers.length > 0) {
            map.setBounds(bounds);
        }
    }

    document.getElementById("loadBtn").onclick = loadCSV;
</script>

</body>
</html>