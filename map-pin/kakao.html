<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸ“ ë§µ ìœ„ì¹˜ í™•ì¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* PC Layout */
        #container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #left {
            width: 360px;
            padding: 12px;
            box-sizing: border-box;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            background: #fafafa;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        button {
            padding: 10px;
            margin: 10px 0 10px 0;
            width: 100%;
            font-size: 16px;
        }

        select {
            width: 100%;
            height: 35px;
            font-size: 16px;
        }

        ul#result {
            padding-left: 20px;
        }

        .mapInfo {padding:5px; width:200px; overflow: scroll; font-size:14px;}

        /* â”€â”€â”€â”€â”€ ğŸ“± ëª¨ë°”ì¼ ëŒ€ì‘ â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            body {
                display: block;
                height: auto;
            }

            #container {
                flex-direction: column;
                height: auto;
            }

            #left {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }

            #map {
                width: 100%;
                height: calc(100vh - 200px); /* ëª¨ë°”ì¼ì—ì„œ ì§€ë„ ê½‰ ì°¨ê²Œ */
            }

            ul#result {
                max-height: 150px;
                overflow-y: auto;
                padding-left: 20px;
            }
        }
    </style>
</head>
<body>
<div id="container">
    <div id="left">
        <select id="area">
            <option value="">== ì§€ì—­ ì„ íƒ ==</option>
            <option value="songpa">ê°•ë‚¨/ê´‘ì§„/ì†¡íŒŒ(13)</option>
            <option value="gangdong">ê°•ë™(18)</option>
            <option value="guro">êµ¬ë¡œ(17)</option>
            <option value="geumcheon">ê¸ˆì²œ(10)</option>
            <option value="gangbuk">ê°•ë¶/ë…¸ì›/ë„ë´‰/ë™ëŒ€ë¬¸/ì„±ë¶/ì¢…ë¡œ(10)</option>
            <option value="eunpyung">ì„œëŒ€ë¬¸/ì€í‰(7)</option>
            <option value="gangseo" selected>ê°•ì„œ/ì–‘ì²œ/ì˜ë“±í¬/ë™ì‘/ê´€ì•…(15)</option>
        </select>
        <button id="loadBtn">CSV í•€ ì°ê¸°</button>
        <div id="status">ìƒíƒœ: ëŒ€ê¸°</div>
        <ul id="result"></ul>
    </div>

    <div id="map"></div>
</div>

<!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK (í•„ìˆ˜: services ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e460c26a9dfe2fa0b1835052c2116608&libraries=services"></script><!--ìš´ì˜-->
<!--<script src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=c9684df8cab7a761f65cd6492b2a3363&libraries=services"></script>&lt;!&ndash;ê°œë°œ&ndash;&gt;-->

<script>
    let map;
    let markers = [];
    let bounds;
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");

    kakao.maps.load(function () {
        bounds = new kakao.maps.LatLngBounds()

        map = new kakao.maps.Map(document.getElementById("map"), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7
        });
    });

    function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
        bounds = new kakao.maps.LatLngBounds();
        resultEl.innerHTML = "";
    }

    async function loadCSV() {

        const file = document.getElementById("area").value;

        if (file === '') {
            alert('ì§€ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”')
            document.getElementById("area").focus()
            return
        }

        statusEl.textContent = "ìƒíƒœ: CSV ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";


        let text;
        try {
            // ğŸ“Œ ì„œë²„ CSV ë¶ˆëŸ¬ì˜¤ê¸°
            const res = await fetch(`./data/${file}.csv`);
            text = await res.text();
        } catch (err) {
            statusEl.textContent = "ìƒíƒœ: CSV ë¡œë“œ ì‹¤íŒ¨";
            return;
        }

        // ğŸ“Œ CSV ì¤„ ë‚˜ëˆ„ê¸°
        const lines = text
            .split(/\r?\n/)
            .map(v => v.trim())
            .filter(v => v.length > 0);

        const list = [];

        // ğŸ“Œ ê° ì¤„ì„ label, address ë¡œ ìë™ ë§¤í•‘
        lines.forEach(line => {
            const cols = line.replace(/"/g, "").split(",");
            if (cols.length >= 2) {
                list.push({
                    label: cols[0].trim(),
                    address: cols[1].trim(),
                    lng: cols[2].trim(),
                    lat: cols[3].trim(),
                    full: cols[4].trim(),
                });
            }
        });

        statusEl.textContent = `ìƒíƒœ: ${list.length}ê°œ ì£¼ì†Œ`;

        await plotAddresses(list);

        statusEl.textContent = "ìƒíƒœ: ì™„ë£Œ";
    }

    async function plotAddresses(list) {
        console.log(list);
        clearMarkers();

        for (const item of list) {
            try {
                const pos = new kakao.maps.LatLng(item.lat, item.lng);
                bounds.extend(pos);

                const marker = new kakao.maps.Marker({ position: pos });
                marker.setMap(map);
                markers.push(marker);

                // new kakao.maps.InfoWindow({
                //     content: `<div style="padding:6px;">${item.address}</div>`
                // }).open(map, marker);

                // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                let infowindow = new kakao.maps.InfoWindow({
                    content : `<div class="mapInfo">${item.full}</div>`,
                    removable : true
                });

                // ë§ˆì»¤ì— í´ë¦­ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                kakao.maps.event.addListener(marker, 'click', function() {
                    // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
                    infowindow.open(map, marker);
                });

                // // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                // kakao.maps.event.addListener(marker, 'mouseover', function() {
                //     // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ë§ˆì»¤ìœ„ì— í‘œì‹œí•©ë‹ˆë‹¤
                //     infowindow.open(map, marker);
                // });

                // // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                // kakao.maps.event.addListener(marker, 'mouseout', function() {
                //     // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤
                //     infowindow.close();
                // });

                resultEl.innerHTML += `<li><strong>${item.label}</strong> <br> ${item.address}</li>`;
            } catch (e) {
                console.error(e);
                resultEl.innerHTML += `<li>${item.label} â†’ ì‹¤íŒ¨</li>`;
            }
        }

        if (markers.length > 0) {
            map.setBounds(bounds);
        }
    }

    document.getElementById("loadBtn").onclick = loadCSV;
</script>

</body>
</html>